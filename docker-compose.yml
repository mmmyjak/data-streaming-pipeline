services:
  postgres:
    image: postgres:15-alpine
    container_name: twitter_postgres
    env_file:
      - ./db/.env
    command: ["postgres", "-c", "wal_level=logical", "-c", "max_replication_slots=4", "-c", "max_wal_senders=4"]
    volumes:
      - ./data/postgres:/var/lib/postgresql/data
      - ./db/init.sql:/docker-entrypoint-initdb.d/init.sql
    networks:
      - twitter_network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-postgres} -d ${POSTGRES_DB:-twitter_db}"]
      interval: 10s
      timeout: 5s
      retries: 5

  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: twitter_pgadmin
    env_file:
      - ./db/.env
    ports:
      - "8080:80"
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - twitter_network
    volumes:
      - ./data/pgadmin:/var/lib/pgadmin

  minio:
    image: minio/minio:latest
    container_name: twitter_minio
    env_file:
      - ./minio/.env
    ports:
      - "9000:9000"   # S3 API
      - "9001:9001"   # MinIO Console
    volumes:
      - ./data/minio:/data
    command: server /data --console-address ":9001"
    networks:
      - twitter_network

  minio-mc:
    image: minio/mc:latest
    container_name: minio-mc
    depends_on:
      - minio
    entrypoint: ["/bin/sh", "/opt/minio/create-bucket.sh"]
    env_file:
      - ./minio/.env
    volumes:
      - ./minio/create-bucket.sh:/opt/minio/create-bucket.sh:ro
    networks:
      - twitter_network        
      
  kafka:
    image: apache/kafka:3.8.0
    container_name: twitter_kafka
    environment:
      KAFKA_NODE_ID: 1
      KAFKA_PROCESS_ROLES: broker,controller
      KAFKA_LISTENERS: PLAINTEXT://0.0.0.0:9092,CONTROLLER://0.0.0.0:9093,PLAINTEXT_HOST://0.0.0.0:29092
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092,PLAINTEXT_HOST://localhost:29092
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,CONTROLLER:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_CONTROLLER_LISTENER_NAMES: CONTROLLER
      KAFKA_CONTROLLER_QUORUM_VOTERS: 1@kafka:9093
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: 'true'
      KAFKA_NUM_PARTITIONS: 3
      CLUSTER_ID: MkU3OEVBNTcwNTJENDM2Qk
    ports:
      - "29092:29092"
      - "9092:9092"
    networks:
      - twitter_network
    volumes:
      - ./data/kafka:/opt/kafka/logs
    healthcheck:
      test: ["CMD-SHELL", "/opt/kafka/bin/kafka-topics.sh --bootstrap-server localhost:9092 --list"]
      interval: 30s
      timeout: 10s
      retries: 5

  kafka-ui:
    image: provectuslabs/kafka-ui:latest
    container_name: twitter_kafka_ui
    depends_on:
      kafka:
        condition: service_healthy
    environment:
      KAFKA_CLUSTERS_0_NAME: twitter-cluster
      KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS: kafka:9092
    ports:
      - "8081:8080"
    networks:
      - twitter_network

  debezium:
    image: debezium/connect:2.7.3.Final
    container_name: twitter_debezium
    depends_on:
      postgres:
        condition: service_healthy
      kafka:
        condition: service_healthy
    environment:
      BOOTSTRAP_SERVERS: kafka:9092
      GROUP_ID: debezium-cluster
      CONFIG_STORAGE_TOPIC: debezium-configs
      OFFSET_STORAGE_TOPIC: debezium-offsets
      STATUS_STORAGE_TOPIC: debezium-status
      CONFIG_STORAGE_REPLICATION_FACTOR: 1
      OFFSET_STORAGE_REPLICATION_FACTOR: 1
      STATUS_STORAGE_REPLICATION_FACTOR: 1
    ports:
      - "8083:8083"
    volumes:
      - ./debezium:/opt/debezium
    networks:
      - twitter_network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8083/"]
      interval: 30s
      timeout: 10s
      retries: 5

  debezium-setup:
    image: curlimages/curl:latest
    container_name: twitter_debezium_setup
    depends_on:
      debezium:
        condition: service_healthy
    volumes:
      - ./debezium:/opt/debezium
      - ./db/.env:/opt/debezium/.env:ro
    networks:
      - twitter_network
    command: sh /opt/debezium/register-connector.sh
    restart: "no"

  twitter_app:
    build: ./business_system
    container_name: twitter_data_app
    env_file:
      - ./business_system/.env
    depends_on:
      postgres:
        condition: service_healthy
      kafka:
        condition: service_healthy
    networks:
      - twitter_network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "python -c 'import psycopg2; print(\"App healthy\")'"]
      interval: 30s
      timeout: 10s
      retries: 3

  spark-master:
    image: spark:3.5.1-python3
    container_name: spark-master
    hostname: spark-master
    ports:
      - "7077:7077"   # Spark Master RPC
      - "8082:8080"   # Spark Master Web UI
    command: >
      bash -c "/opt/spark/bin/spark-class org.apache.spark.deploy.master.Master --host spark-master --port 7077 --webui-port 8080"
    networks:
      - twitter_network
    depends_on:
      kafka:
        condition: service_healthy

  spark-worker:
    image: spark:3.5.1-python3
    container_name: spark-worker
    hostname: spark-worker
    ports:
      - "8084:8081"   # Spark Worker Web UI
    environment:
      SPARK_WORKER_CORES: 2
      SPARK_WORKER_MEMORY: 2g
    command: >
      bash -c "/opt/spark/bin/spark-class org.apache.spark.deploy.worker.Worker spark://spark-master:7077 --webui-port 8081"
    networks:
      - twitter_network
    depends_on:
      - spark-master

  spark-app:
    image: spark:3.5.1-python3
    container_name: spark-app
    env_file:
      - ./spark/.env
    volumes:
      - ./spark/app:/opt/spark-app
      - ./spark/output:/opt/spark/output
      - ./spark/ivy2:/home/spark/.ivy2
    networks:
      - twitter_network
    depends_on:
      - spark-master
      - spark-worker
      - kafka
      - minio
    command: 
      - bash
      - -c
      - |
        sleep 10
        /opt/spark/bin/spark-submit \
          --master spark://spark-master:7077 \
          --packages org.apache.spark:spark-sql-kafka-0-10_2.12:3.5.1,org.apache.hadoop:hadoop-aws:3.3.4,com.amazonaws:aws-java-sdk-bundle:1.12.262 \
          /opt/spark-app/app.py

networks:
  twitter_network:
    driver: bridge